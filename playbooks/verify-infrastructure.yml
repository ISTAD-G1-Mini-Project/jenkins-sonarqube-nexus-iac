---
# Dynamic Verification Playbook
# Usage: ansible-playbook -i inventory.ini playbooks/verify-infrastructure.yml

- name: Verify Infrastructure Health
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Display machine info
      debug:
        msg: |
          Hostname: {{ ansible_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          IP: {{ ansible_default_ipv4.address }}
          Memory: {{ ansible_memtotal_mb }} MB

- name: Verify Services on all machines dynamically
  hosts: all
  become: yes
  gather_facts: yes
  vars_files:
    - ../vars/gcp_vars.yml

  tasks:
    - name: Check Docker is running
      systemd:
        name: docker
      register: docker_status

    - name: Get all container info dynamically
      docker_container_info:
        name: "{{ item }}"
      register: container_info
      ignore_errors: yes
      loop: "{{ service_containers[inventory_hostname] | default([]) }}"
      loop_control:
        label: "{{ item }}"

    - name: Check Nginx status
      systemd:
        name: nginx
      register: nginx_status

    - name: Check listening ports
      wait_for:
        port: "{{ item }}"
        timeout: 5
      register: port_status
      ignore_errors: yes
      loop: "{{ service_ports[inventory_hostname] | default([]) }}"
      loop_control:
        label: "Port {{ item }}"

    - name: Display machine service status
      debug:
        msg: |
          Machine: {{ inventory_hostname }}
          Docker: {{ docker_status.status.ActiveState }}
          Containers:
          {% for c in container_info.results %}
            - {{ c.invocation.module_args.name }}: {{ c.exists | ternary('Running', 'Not Found') }}
          {% endfor %}
          Nginx: {{ nginx_status.status.ActiveState }}
          Ports:
          {% for p in port_status.results %}
            - Port {{ p.item }}: {{ p.failed | ternary('Not Listening', 'Listening') }}
          {% endfor %}

- name: Check SSL Certificates
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Check if certbot is installed
      command: which certbot
      register: certbot_check
      changed_when: false
      ignore_errors: yes

    - name: List SSL certificates
      command: certbot certificates
      register: cert_list
      changed_when: false
      ignore_errors: yes
      when: certbot_check.rc == 0

    - name: Display certificate status
      debug:
        var: cert_list.stdout_lines
      when: 
        - certbot_check.rc == 0
        - cert_list.rc == 0

- name: Infrastructure Health Summary
  hosts: localhost
  gather_facts: no

  vars_files:
    - ../vars/gcp_vars.yml

  tasks:
    - name: Display summary
      debug:
        msg: |
          Infrastructure Verification Complete!
          Review the output above for any issues.
          
          Expected services (dynamic):
          {% for machine in machines %}
          - {{ machine.name }}: Containers -> {{ service_containers[machine.host] | default([]) }}, Ports -> {{ service_ports[machine.host] | default([]) }}
          {% endfor %}
          
          Next steps:
          1. Check any failed services
          2. Review logs: docker logs <container_name>
          3. Verify DNS configuration
          4. Test HTTPS endpoints
