---
# Destroy GCP Infrastructure Playbook
# This will delete ALL GCP resources created by the setup playbook
# Usage: ansible-playbook destroy-gcp-infrastructure.yml

- name: Confirm Destruction
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Warning message
      debug:
        msg: |
          ⚠⚠⚠ CRITICAL WARNING ⚠⚠⚠
          
          This will PERMANENTLY DELETE:
          - All 3 GCP VM instances
          - All data and configurations
          - Network and firewall rules
          - Everything cannot be recovered!
          
          Type 'DESTROY' to confirm destruction.

    - name: Prompt for confirmation
      pause:
        prompt: "Type 'DESTROY' to confirm (or Ctrl+C to cancel)"
      register: confirm_destroy
    
    - name: Check confirmation
      fail:
        msg: "Infrastructure destruction cancelled - confirmation not received"
      when: confirm_destroy.user_input != "DESTROY"

- name: Destroy Infrastructure Services (if VMs exist)
  hosts: all
  become: yes
  gather_facts: no
  ignore_errors: yes
  ignore_unreachable: yes
  
  tasks:
    - name: Stop all Docker containers
      shell: docker stop $(docker ps -aq)
      ignore_errors: yes
    
    - name: Remove all Docker containers
      shell: docker rm -f $(docker ps -aq)
      ignore_errors: yes
    
    - name: Remove all Docker volumes
      shell: docker volume rm $(docker volume ls -q)
      ignore_errors: yes
    
    - name: Remove all Docker networks
      shell: docker network rm $(docker network ls -q)
      ignore_errors: yes

- name: Destroy GCP Resources
  hosts: localhost
  gather_facts: no
  vars_files:
    - gcp_vars.yml
  
  tasks:
    - name: Delete Machine01 - Jenkins Server
      google.cloud.gcp_compute_instance:
        name: "{{ machine01_name }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      register: delete_machine01
      ignore_errors: yes

    - name: Delete Machine02 - SonarQube Server
      google.cloud.gcp_compute_instance:
        name: "{{ machine02_name }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      register: delete_machine02
      ignore_errors: yes

    - name: Delete Machine03 - Nexus Server
      google.cloud.gcp_compute_instance:
        name: "{{ machine03_name }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      register: delete_machine03
      ignore_errors: yes

    - name: Wait for VM deletion to complete
      pause:
        seconds: 30

    - name: Delete Firewall Rule - Services
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-services"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Delete Firewall Rule - Portainer
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-portainer"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Delete Firewall Rule - HTTP/HTTPS
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-http-https"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Delete Firewall Rule - SSH
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-ssh"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Delete Subnet
      google.cloud.gcp_compute_subnetwork:
        name: "{{ subnet_name }}"
        region: "{{ gcp_region }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Delete VPC Network
      google.cloud.gcp_compute_network:
        name: "{{ network_name }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Remove local inventory file
      file:
        path: inventory.ini
        state: absent
      ignore_errors: yes

    - name: Remove VM info file
      file:
        path: ./vm-info.txt
        state: absent
      ignore_errors: yes

    - name: Destruction Summary
      debug:
        msg: |
          ==========================================
          Infrastructure Destruction Complete!
          ==========================================
          
          Deleted Resources:
          - Machine01 (Jenkins): {{ 'SUCCESS' if delete_machine01 is succeeded else 'FAILED/NOT FOUND' }}
          - Machine02 (SonarQube): {{ 'SUCCESS' if delete_machine02 is succeeded else 'FAILED/NOT FOUND' }}
          - Machine03 (Nexus): {{ 'SUCCESS' if delete_machine03 is succeeded else 'FAILED/NOT FOUND' }}
          - Firewall rules: Removed
          - VPC Network: Removed
          - Subnet: Removed
          
          All GCP resources have been destroyed.
          
          Note: DNS records must be manually removed if configured.
          Check your GCP Console to verify all resources are deleted.

    - name: Save destruction log
      copy:
        content: |
          GCP Infrastructure Destroyed: {{ ansible_date_time.iso8601 }}
          
          Resources Deleted:
          - {{ machine01_name }} (Jenkins)
          - {{ machine02_name }} (SonarQube)
          - {{ machine03_name }} (Nexus)
          - Network: {{ network_name }}
          - Subnet: {{ subnet_name }}
          - All firewall rules
          
          Manual cleanup required:
          - DNS records (if configured)
          - Service account key file (if no longer needed)
        dest: ./destruction-log.txt
        mode: '0644'
