---
# Destroy GCP Infrastructure Playbook (Dynamic)
# Deletes all VMs, firewall rules, subnet, and network
# Usage: ansible-playbook destroy-gcp-infrastructure.yml

- name: Destroy Infrastructure Services (if VMs exist)
  hosts: all
  become: yes
  gather_facts: no
  ignore_errors: yes
  ignore_unreachable: yes
  tasks:
    - name: Stop all Docker containers
      shell: docker stop $(docker ps -aq)
      ignore_errors: yes

    - name: Remove all Docker containers
      shell: docker rm -f $(docker ps -aq)
      ignore_errors: yes

    - name: Remove all Docker volumes
      shell: docker volume rm $(docker volume ls -q)
      ignore_errors: yes

    - name: Remove all Docker networks
      shell: docker network rm $(docker network ls -q)
      ignore_errors: yes

- name: Destroy GCP Resources dynamically
  hosts: localhost
  gather_facts: no
  vars_files:
    - ../../vars/gcp_vars.yml
  vars:
    ansible_python_interpreter: "/Users/macbookpro/Desktop/ansible-gcp-infrastructure/.venv/bin/python"

  tasks:
    - name: Delete all VMs
      google.cloud.gcp_compute_instance:
        name: "{{ item.name }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      loop: "{{ machines }}"
      loop_control:
        label: "{{ item.name }}"
      register: deleted_machines
      ignore_errors: yes

    - name: Wait for VM deletion to complete
      pause:
        seconds: 30

    - name: Delete Firewall Rules dynamically
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-{{ item }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      loop: "{{ machines | map(attribute='name') | map('split','-') | map('first') | list | unique }}"
      loop_control:
        label: "{{ item }}"
      ignore_errors: yes

    - name: Delete Subnet
      google.cloud.gcp_compute_subnetwork:
        name: "{{ subnet_name }}"
        region: "{{ gcp_region }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Delete VPC Network
      google.cloud.gcp_compute_network:
        name: "{{ network_name }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Remove local inventory file
      file:
        path: ../../inventory.ini
        state: absent
      ignore_errors: yes

    - name: Destruction Summary
      debug:
        msg: |
          ==========================================
          Infrastructure Destruction Complete!
          ==========================================
          
          Deleted Machines:
          {% for machine, result in machines|zip(deleted_machines.results) %}
          - {{ machine.name }}: {{ 'SUCCESS' if result is succeeded else 'FAILED/NOT FOUND' }}
          {% endfor %}
          
          Firewall rules, Subnet, and VPC Network removed.
          DNS records must be manually removed if configured.

    - name: Save destruction log
      copy:
        content: |
          GCP Infrastructure Destroyed: {{ ansible_date_time.iso8601 }}
          
          Deleted Machines:
          {% for machine, result in machines|zip(deleted_machines.results) %}
          - {{ machine.name }}
          {% endfor %}
          
          Network: {{ network_name }}
          Subnet: {{ subnet_name }}
          Firewall rules removed
          
          Manual cleanup required:
          - DNS records (if configured)
          - Service account key file (if no longer needed)
        dest: ../destruction-log.txt
        mode: '0644'
