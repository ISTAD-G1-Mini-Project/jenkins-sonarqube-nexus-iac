---
# Destroy GCP Infrastructure Playbook (Dynamic)
# Deletes all VMs, firewall rules, subnet, and network
# Usage: ansible-playbook destroy-gcp-infrastructure.yml

- name: Destroy GCP Resources dynamically
  hosts: localhost
  gather_facts: no
  become: no
  vars_files:
    - ../../vars/gcp_vars.yml
    
  tasks:
    - name: Delete Firewall Rules
      google.cloud.gcp_compute_firewall:
        name: "{{ item }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      loop: "{{ firewall_rules }}"
      ignore_errors: yes

    - name: Delete all VMs
      google.cloud.gcp_compute_instance:
        name: "{{ item.name }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      loop: "{{ machines }}"
      loop_control:
        label: "{{ item.name }}"
      register: deleted_machines
      ignore_errors: yes

    - name: Wait for VM deletion to complete
      pause:
        seconds: 30

    - name: Delete Subnet
      google.cloud.gcp_compute_subnetwork:
        name: "{{ subnet_name }}"
        region: "{{ gcp_region }}"
        network: "{{ network_name }}"
        project: "{{ gcp_project_id }}"
        ip_cidr_range: "{{ subnet_cidr }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Delete VPC Network
      google.cloud.gcp_compute_network:
        name: "{{ network_name }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: absent
      ignore_errors: yes

    - name: Remove local inventory file
      file:
        path: ../../inventory.ini
        state: absent
      ignore_errors: yes

    - name: Remove local gcp_instance file
      file:
        path: ../gcp_instance.json
        state: absent
      ignore_errors: yes

    - name: Destruction Summary
      debug:
        msg: |
          ==========================================
          Infrastructure Destruction Complete!
          ==========================================
          
          Deleted Machines:
          {% for machine, result in machines|zip(deleted_machines.results) %}
          - {{ machine.name }}: {{ 'SUCCESS' if result is succeeded else 'FAILED/NOT FOUND' }}
          {% endfor %}
          
          Firewall rules, Subnet, and VPC Network removed.
          DNS records must be manually removed if configured.
