---
- name: Full Infrastructure Verification
  hosts: all
  become: yes
  gather_facts: no

  tasks:

    - name: Show hostname
      command: hostname
      register: hostname_output

    - debug:
        msg: "===== {{ hostname_output.stdout }} ====="

    - name: Check glab
      shell: command -v glab
      register: glab_check
      ignore_errors: yes
      when: inventory_hostname in groups['jenkins_group']

    - name: Check docker
      shell: command -v docker
      register: docker_check
      ignore_errors: yes

    - name: Check docker compose
      shell: docker compose version
      register: compose_check
      ignore_errors: yes

    - name: Check ansible
      shell: command -v ansible
      register: ansible_check
      ignore_errors: yes
      when: inventory_hostname in groups['jenkins_group']

    - name: Check nginx
      shell: command -v nginx
      register: nginx_check
      ignore_errors: yes

    - name: Check certbot
      shell: command -v certbot
      register: certbot_check
      ignore_errors: yes

    - name: Check Oh My Zsh
      stat:
        path: ~/.oh-my-zsh
      register: ohmyzsh_check

    - name: Check Portainer container
      shell: docker ps -a | grep -i portainer
      register: portainer_check
      ignore_errors: yes

    - name: Check Jenkins container
      shell: docker ps -a | grep -i jenkins
      register: jenkins_check
      ignore_errors: yes
      when: inventory_hostname in groups['jenkins_group']

    - name: Check SonarQube container
      shell: docker ps -a | grep -i sonarqube
      register: sonar_check
      ignore_errors: yes
      when: inventory_hostname in groups['sonarqube_group']

    - name: Check Nexus container
      shell: docker ps -a | grep -i nexus
      register: nexus_check
      ignore_errors: yes
      when: inventory_hostname in groups['nexus_group']

    - name: Display Summary
      debug:
        msg:
          - "glab:           {{ 'N/A' if glab_check.rc is not defined else ('OK' if glab_check.rc == 0 else 'MISSING') }}"
          - "docker:         {{ 'OK' if docker_check.rc | default(1) == 0 else 'MISSING' }}"
          - "docker compose: {{ 'OK' if compose_check.rc | default(1) == 0 else 'MISSING' }}"
          - "ansible:        {{ 'N/A' if ansible_check.rc is not defined else ('OK' if ansible_check.rc == 0 else 'MISSING') }}"
          - "nginx:          {{ 'OK' if nginx_check.rc | default(1) == 0 else 'MISSING' }}"
          - "certbot:        {{ 'OK' if certbot_check.rc | default(1) == 0 else 'MISSING' }}"
          - "ohmyzsh:        {{ 'OK' if ohmyzsh_check.stat.exists else 'MISSING' }}"
          - "portainer:      {{ 'OK' if portainer_check.rc | default(1) == 0 else 'NOT FOUND' }}"
          - "jenkins:        {{ 'N/A' if jenkins_check.rc is not defined else ('OK' if jenkins_check.rc == 0 else 'NOT FOUND') }}"
          - "sonarqube:      {{ 'N/A' if sonar_check.rc is not defined else ('OK' if sonar_check.rc == 0 else 'NOT FOUND') }}"
          - "nexus:          {{ 'N/A' if nexus_check.rc is not defined else ('OK' if nexus_check.rc == 0 else 'NOT FOUND') }}"