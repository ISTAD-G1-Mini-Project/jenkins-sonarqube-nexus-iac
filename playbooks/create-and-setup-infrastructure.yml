---
# Main Playbook: Create GCP VMs and Setup Complete Infrastructure
# Usage: ansible-playbook -i localhost, create-and-setup-infrastructure.yml

- name: Create GCP Infrastructure
  hosts: localhost
  connection: local 
  become: yes 
  gather_facts: yes
  vars_files:
    - ../vars/gcp_vars.yml
  vars:
    ansible_python_interpreter: "/Users/macbookpro/Desktop/ansible-gcp-infrastructure/.venv/bin/python"
  
  tasks:
    - name: Display setup information
      debug:
        msg: |
          Creating GCP Infrastructure:
          - Project: {{ gcp_project_id }}
          - Region: {{ gcp_region }}
          - Zone: {{ gcp_zone }}
          - Machines: {{ machine01_name }}, {{ machine02_name }}, {{ machine03_name }}

    - name: Ensure GCP service account file exists
      stat:
        path: "{{ gcp_service_account_file }}"
      register: sa_file
      failed_when: not sa_file.stat.exists

    - name: Create VPC Network
      google.cloud.gcp_compute_network:
        name: "{{ network_name }}"
        auto_create_subnetworks: no
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: present
      register: network

    - name: Create Subnet
      google.cloud.gcp_compute_subnetwork:
        name: "{{ subnet_name }}"
        region: "{{ gcp_region }}"
        network: "{{ network }}"
        ip_cidr_range: "{{ subnet_cidr }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: present
      register: subnet

    - name: Create Firewall Rule - Allow SSH
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-ssh"
        network: "{{ network }}"
        allowed:
          - ip_protocol: tcp
            ports:
              - '22'
        source_ranges:
          - '0.0.0.0/0'
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: present

    - name: Create Firewall Rule - Allow HTTP/HTTPS
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-http-https"
        network: "{{ network }}"
        allowed:
          - ip_protocol: tcp
            ports:
              - '80'
              - '443'
        source_ranges:
          - '0.0.0.0/0'
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: present

    - name: Create Firewall Rule - Allow Portainer
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-portainer"
        network: "{{ network }}"
        allowed:
          - ip_protocol: tcp
            ports:
              - '9000'
        source_ranges:
          - '0.0.0.0/0'
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: present

    - name: Create Firewall Rule - Allow Jenkins, SonarQube, Nexus ports
      google.cloud.gcp_compute_firewall:
        name: "{{ network_name }}-allow-services"
        network: "{{ network }}"
        allowed:
          - ip_protocol: tcp
            ports:
              - '8080'  # Jenkins
              - '8081'  # Nexus
              - '8082'  # Docker registry
              - '8083'  # Helm registry
              - '9001'  # SonarQube
        source_ranges:
          - '0.0.0.0/0'
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        state: present

    - name: Read SSH public key
      slurp:
        src: "{{ ssh_public_key_file }}"
      register: ssh_key_content

    - name: Create Machine01 - Jenkins Server
      google.cloud.gcp_compute_instance:
        name: "{{ machine01_name }}"
        machine_type: "{{ machine_type }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        disks:
          - auto_delete: true
            boot: true
            initialize_params:
              disk_size_gb: "{{ boot_disk_size }}"
              disk_type: "{{ boot_disk_type }}"
              source_image: "projects/{{ image_project }}/global/images/family/{{ image_family }}"
        network_interfaces:
          - network: "{{ network }}"
            subnetwork: "{{ subnet }}"
            access_configs:
              - name: External NAT
                type: ONE_TO_ONE_NAT
        metadata:
          ssh-keys: "{{ ssh_user }}:{{ ssh_key_content.content | b64decode }}"
        tags:
          items:
            - jenkins
            - http-server
            - https-server
        labels: "{{ resource_tags }}"
        state: present
      register: machine01

    - name: Create Machine02 - SonarQube Server
      google.cloud.gcp_compute_instance:
        name: "{{ machine02_name }}"
        machine_type: "{{ machine_type }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        disks:
          - auto_delete: true
            boot: true
            initialize_params:
              disk_size_gb: "{{ boot_disk_size }}"
              disk_type: "{{ boot_disk_type }}"
              source_image: "projects/{{ image_project }}/global/images/family/{{ image_family }}"
        network_interfaces:
          - network: "{{ network }}"
            subnetwork: "{{ subnet }}"
            access_configs:
              - name: External NAT
                type: ONE_TO_ONE_NAT
        metadata:
          ssh-keys: "{{ ssh_user }}:{{ ssh_key_content.content | b64decode }}"
        tags:
          items:
            - sonarqube
            - http-server
            - https-server
        labels: "{{ resource_tags }}"
        state: present
      register: machine02

    - name: Create Machine03 - Nexus Server
      google.cloud.gcp_compute_instance:
        name: "{{ machine03_name }}"
        machine_type: "{{ machine_type }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_service_account_file }}"
        disks:
          - auto_delete: true
            boot: true
            initialize_params:
              disk_size_gb: "{{ boot_disk_size }}"
              disk_type: "{{ boot_disk_type }}"
              source_image: "projects/{{ image_project }}/global/images/family/{{ image_family }}"
        network_interfaces:
          - network: "{{ network }}"
            subnetwork: "{{ subnet }}"
            access_configs:
              - name: External NAT
                type: ONE_TO_ONE_NAT
        metadata:
          ssh-keys: "{{ ssh_user }}:{{ ssh_key_content.content | b64decode }}"
        tags:
          items:
            - nexus
            - http-server
            - https-server
        labels: "{{ resource_tags }}"
        state: present
      register: machine03

    - name: Wait for SSH to become available on all machines
      wait_for:
        host: "{{ item }}"
        port: 22
        delay: 10
        timeout: 300
      loop:
        - "{{ machine01.networkInterfaces[0].accessConfigs[0].natIP }}"
        - "{{ machine02.networkInterfaces[0].accessConfigs[0].natIP }}"
        - "{{ machine03.networkInterfaces[0].accessConfigs[0].natIP }}"

    - name: Create dynamic inventory file
      copy:
        content: |
          [all:vars]
          ansible_user={{ ssh_user }}
          ansible_ssh_private_key_file=~/.ssh/id_rsa
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          
          jenkins_domain={{ jenkins_domain }}
          sonarqube_domain={{ sonarqube_domain }}
          nexus_domain={{ nexus_domain }}
          admin_email={{ admin_email }}
          
          [jenkins_group]
          jenkins ansible_host={{ machine01.networkInterfaces[0].accessConfigs[0].natIP }}
          
          [sonarqube_group]
          sonarqube ansible_host={{ machine02.networkInterfaces[0].accessConfigs[0].natIP }}
          
          [nexus_group]
          nexus ansible_host={{ machine03.networkInterfaces[0].accessConfigs[0].natIP }}
        dest: inventory.ini
        mode: '0644'

    - name: Display VM information
      debug:
        msg: |
          VMs Created Successfully!
          
          Machine01 (Jenkins):
            - Name: {{ machine01_name }}
            - Internal IP: {{ machine01.networkInterfaces[0].networkIP }}
            - External IP: {{ machine01.networkInterfaces[0].accessConfigs[0].natIP }}
          
          Machine02 (SonarQube):
            - Name: {{ machine02_name }}
            - Internal IP: {{ machine02.networkInterfaces[0].networkIP }}
            - External IP: {{ machine02.networkInterfaces[0].accessConfigs[0].natIP }}
          
          Machine03 (Nexus):
            - Name: {{ machine03_name }}
            - Internal IP: {{ machine03.networkInterfaces[0].networkIP }}
            - External IP: {{ machine03.networkInterfaces[0].accessConfigs[0].natIP }}
          
          DNS Configuration Required:
          {{ jenkins_domain }} -> {{ machine01.networkInterfaces[0].accessConfigs[0].natIP }}
          {{ sonarqube_domain }} -> {{ machine02.networkInterfaces[0].accessConfigs[0].natIP }}
          {{ nexus_domain }} -> {{ machine03.networkInterfaces[0].accessConfigs[0].natIP }}
          
          Inventory file created: ./inventory.ini
          
          Next: Run the setup playbook to configure the VMs

    - name: Save VM information to file
      copy:
        content: |
          GCP Infrastructure Created: {{ ansible_date_time.iso8601 }}
          
          Machine01 (Jenkins):
            Name: {{ machine01_name }}
            Internal IP: {{ machine01.networkInterfaces[0].networkIP }}
            External IP: {{ machine01.networkInterfaces[0].accessConfigs[0].natIP }}
            SSH: ssh {{ ssh_user }}@{{ machine01.networkInterfaces[0].accessConfigs[0].natIP }}
          
          Machine02 (SonarQube):
            Name: {{ machine02_name }}
            Internal IP: {{ machine02.networkInterfaces[0].networkIP }}
            External IP: {{ machine02.networkInterfaces[0].accessConfigs[0].natIP }}
            SSH: ssh {{ ssh_user }}@{{ machine02.networkInterfaces[0].accessConfigs[0].natIP }}
          
          Machine03 (Nexus):
            Name: {{ machine03_name }}
            Internal IP: {{ machine03.networkInterfaces[0].networkIP }}
            External IP: {{ machine03.networkInterfaces[0].accessConfigs[0].natIP }}
            SSH: ssh {{ ssh_user }}@{{ machine03.networkInterfaces[0].accessConfigs[0].natIP }}
          
          DNS Records to Create:
          {{ jenkins_domain }} A {{ machine01.networkInterfaces[0].accessConfigs[0].natIP }}
          {{ sonarqube_domain }} A {{ machine02.networkInterfaces[0].accessConfigs[0].natIP }}
          {{ nexus_domain }} A {{ machine03.networkInterfaces[0].accessConfigs[0].natIP }}
        dest: ./vm-info.txt
        mode: '0644'

- name: Configure Infrastructure
  import_playbook: setup-infrastructure.yml

- name: Complete
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Final message
      debug:
        msg: |
          ==========================================
          Infrastructure Setup Complete!
          ==========================================
          
          Your services are being configured and will be available soon.
          
          Check vm-info.txt for all IP addresses and SSH commands.
          
          Next Steps:
          1. Configure DNS records (see vm-info.txt)
          2. Wait for DNS propagation (5-60 minutes)
          3. Run: ansible-playbook setup-ssl.yml
