---
# SSL Certificate Setup Playbook
# This should be run AFTER the main setup and DNS is configured
# Usage: ansible-playbook -i inventory.ini setup-ssl.yml

- name: Setup SSL Certificates with Let's Encrypt
  hosts: localhost
  become: yes
  connection: local
  gather_facts: yes
  
  tasks:
    # - name: Ensure DNS is configured
    #   pause:
    #     prompt: |
    #       Before proceeding, ensure that:
    #       1. DNS A records are configured for all domains
    #       2. Domains are pointing to the correct IP addresses
    #       3. Ports 80 and 443 are accessible from the internet
          
    #       Press ENTER to continue or Ctrl+C to abort

- name: Setup Jenkins SSL Certificate
  hosts: machine01
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Obtain SSL certificate for Jenkins
      command: >
        certbot --nginx
        -d {{ jenkins_domain }}
        --non-interactive
        --agree-tos
        --email {{ admin_email }}
        --redirect
      register: certbot_jenkins
      changed_when: "'Successfully received certificate' in certbot_jenkins.stdout"
      failed_when: 
        - certbot_jenkins.rc != 0
        - "'Certificate not yet due for renewal' not in certbot_jenkins.stdout"
    
    - name: Reload Nginx for Jenkins
      systemd:
        name: nginx
        state: reloaded

- name: Setup SonarQube SSL Certificate
  hosts: machine02
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Obtain SSL certificate for SonarQube
      command: >
        certbot --nginx
        -d {{ sonarqube_domain }}
        --non-interactive
        --agree-tos
        --email {{ admin_email }}
        --redirect
      register: certbot_sonarqube
      changed_when: "'Successfully received certificate' in certbot_sonarqube.stdout"
      failed_when: 
        - certbot_sonarqube.rc != 0
        - "'Certificate not yet due for renewal' not in certbot_sonarqube.stdout"
    
    - name: Reload Nginx for SonarQube
      systemd:
        name: nginx
        state: reloaded

- name: Setup Nexus SSL Certificates
  hosts: machine03
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Obtain SSL certificate for Nexus main domain
      command: >
        certbot --nginx
        -d {{ nexus_domain }}
        --non-interactive
        --agree-tos
        --email {{ admin_email }}
        --redirect
      register: certbot_nexus
      changed_when: "'Successfully received certificate' in certbot_nexus.stdout"
      failed_when: 
        - certbot_nexus.rc != 0
        - "'Certificate not yet due for renewal' not in certbot_nexus.stdout"
    
    - name: Obtain SSL certificate for Docker registry
      command: >
        certbot --nginx
        -d docker.{{ nexus_domain }}
        --non-interactive
        --agree-tos
        --email {{ admin_email }}
        --redirect
      register: certbot_docker
      changed_when: "'Successfully received certificate' in certbot_docker.stdout"
      failed_when: 
        - certbot_docker.rc != 0
        - "'Certificate not yet due for renewal' not in certbot_docker.stdout"
    
    - name: Obtain SSL certificate for Helm registry
      command: >
        certbot --nginx
        -d helm.{{ nexus_domain }}
        --non-interactive
        --agree-tos
        --email {{ admin_email }}
        --redirect
      register: certbot_helm
      changed_when: "'Successfully received certificate' in certbot_helm.stdout"
      failed_when: 
        - certbot_helm.rc != 0
        - "'Certificate not yet due for renewal' not in certbot_helm.stdout"
    
    - name: Reload Nginx for Nexus
      systemd:
        name: nginx
        state: reloaded

- name: Setup Certificate Auto-Renewal
  hosts: localhost
  become: yes
  connection: local
  gather_facts: yes
  
  tasks:
    - name: Test certbot renewal
      command: certbot renew --dry-run
      changed_when: false
    
    - name: Display renewal cron job
      debug:
        msg: |
          Certbot auto-renewal is configured via systemd timer.
          Check status with: systemctl status certbot.timer
          
          Certificates will auto-renew when they have 30 days or less remaining.

- name: SSL Setup Complete
  hosts: localhost
  become: yes
  connection: local
  gather_facts: no
  vars_files:
    - ../vars/gcp_vars.yml
  
  tasks:
    - name: Display completion message
      debug:
        msg: |
          SSL certificates have been successfully configured!
          
          Your services are now accessible at:
          - Jenkins: https://{{ jenkins_domain }}
          - SonarQube: https://{{ sonarqube_domain }}
          - Nexus: https://{{ nexus_domain }}
          
          Certificates will automatically renew before expiration.
