---
# Nexus role - Setup Nexus Repository Manager

- name: Create Nexus data directory
  file:
    path: /opt/nexus-data
    state: directory
    owner: "200"
    group: "200"
    mode: "0755"

- name: Create Nexus container (Docker Blob Repository)
  docker_container:
    name: nexus-docker
    image: sonatype/nexus3:latest
    state: started
    restart_policy: always
    ports:
      - "8081:8081"
      - "8082:8082" # Docker hosted repository
      - "8083:8083" # Docker proxy repository
    volumes:
      - nexus_data:/nexus-data
    networks:
      - name: app_network
    env:
      INSTALL4J_ADD_VM_PARAMS: "-Xms2g -Xmx2g -XX:MaxDirectMemorySize=3g"

- name: Wait for Nexus to start
  wait_for:
    port: 8081
    delay: 60
    timeout: 600

- name: Wait additional time for Nexus initialization
  wait_for:
    timeout: 30
  delegate_to: localhost

- name: Check if admin password file exists
  shell: docker exec nexus-docker test -f /nexus-data/admin.password && echo "exists" || echo "not_found"
  register: admin_password_check
  changed_when: false
  ignore_errors: yes

- name: Get Nexus initial admin password
  shell: docker exec nexus-docker cat /nexus-data/admin.password
  register: nexus_password
  changed_when: false
  ignore_errors: yes
  when: admin_password_check.stdout == "exists"

- name: Display Nexus initial password
  debug:
    msg: "Nexus initial admin password: {{ nexus_password.stdout }}"
  when:
    - admin_password_check.stdout == "exists"
    - nexus_password.stdout is defined
  
- name: Get domain for current machine
  set_fact:
    current_domain: >-
      {{
        (machines
        | selectattr('host', 'equalto', group_names[0])
        | map(attribute='domains')
        | first)[0]
      }}

- name: Display Nexus information
  debug:
    msg: |
      Nexus Repository Manager is running at http://{{ current_domain }}

      Default username: admin
      {% if admin_password_check.stdout == "exists" and nexus_password.stdout is defined %}
      Initial password: {{ nexus_password.stdout }}
      {% else %}
      Initial password: Check /nexus-data/admin.password in the container
      {% endif %}

      Repository Setup Instructions:
      1. Login with admin credentials
      2. Complete the setup wizard
      3. Create Docker Blob Store repository (uses docker-blob)
      4. Configure connectors on ports 8082 (Docker)

      Docker Repository will be accessible at: {{ current_domain }}:8082
