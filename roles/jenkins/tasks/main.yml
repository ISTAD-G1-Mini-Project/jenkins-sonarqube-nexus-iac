---
# Jenkins role - Setup Jenkins with Docker

- name: Install GitLab CLI (glab)
  block:
    - name: Download glab
      get_url:
        url: "https://gitlab.com/gitlab-org/cli/-/releases/v1.36.0/downloads/glab_1.36.0_Linux_x86_64.deb"
        dest: /tmp/glab.deb

    - name: Install glab
      apt:
        deb: /tmp/glab.deb
        state: present

# ========================
# Jenkins setup
# ========================

- name: Create Jenkins directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  loop:
    - /var/jenkins_home
    - /var/jenkins_home/certs

- name: Create Jenkins Docker container
  docker_container:
    name: jenkins
    image: jenkins/jenkins:lts
    state: started
    restart_policy: always
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_docker_certs:/certs/client:ro
    env:
      DOCKER_HOST: "tcp://docker:2376"
      DOCKER_CERT_PATH: "/certs/client"
      DOCKER_TLS_VERIFY: "1"
      JENKINS_ADMIN_ID: "{{ jenkins_admin_user }}"
      JENKINS_ADMIN_PASSWORD: "{{ jenkins_admin_password }}"
      JAVA_OPTS: "-Djenkins.install.runSetupWizard=false"
    networks:
      - name: app_network
    user: root

- name: Wait for Jenkins to start
  wait_for:
    host: 127.0.0.1
    port: 8080
    delay: 10
    timeout: 300

- name: Install Ansible
  apt:
    name:
      - ansible
      - ansible-lint
    state: present

# ========================
#  SSL
# ========================

# - name: Install Nginx
#   apt:
#     name: nginx
#     state: present
#     update_cache: yes

# - name: Install Certbot
#   apt:
#     name:
#       - certbot
#       - python3-certbot-nginx
#     state: present

# - name: Configure temporary HTTP-only Nginx site for Jenkins
#   template:
#     src: jenkins-http.conf.j2
#     dest: /etc/nginx/sites-available/jenkins
#     mode: "0644"
#   notify: restart nginx

# - name: Enable Jenkins site
#   file:
#     src: /etc/nginx/sites-available/jenkins
#     dest: /etc/nginx/sites-enabled/jenkins
#     state: link
#   notify: restart nginx

# - name: Remove default Nginx site
#   file:
#     path: /etc/nginx/sites-enabled/default
#     state: absent
#   notify: restart nginx

# - name: Start and enable Nginx
#   systemd:
#     name: nginx
#     state: started
#     enabled: yes

# - name: Wait for HTTP to be ready
#   wait_for:
#     host: 127.0.0.1
#     port: 80
#     delay: 5
#     timeout: 60

# - name: Obtain SSL certificate via Certbot
#   shell: certbot --nginx -d {{ jenkins_domain }} --non-interactive --agree-tos -m {{ admin_email }}
#   register: certbot_result
#   changed_when: certbot_result.rc == 0
#   notify: reload nginx

# - name: Wait for HTTPS to be ready
#   wait_for:
#     host: 127.0.0.1
#     port: 443
#     delay: 5
#     timeout: 120

# ========================
# Jenkins password retrieval (safe)
# ========================

# - name: Check if initialAdminPassword exists
#   stat:
#     path: /var/jenkins_home/secrets/initialAdminPassword
#   register: jenkins_password_file

# - name: Get Jenkins initial admin password
#   command: docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
#   register: jenkins_password
#   retries: 10
#   delay: 15
#   until: jenkins_password.rc == 0
#   when: jenkins_password_file.stat.exists

# - name: Display Jenkins initial password
#   debug:
#     msg: "Jenkins initial admin password: {{ jenkins_password.stdout }}"
#   when:
#     - jenkins_password_file.stat.exists
#     - jenkins_password.stdout is defined
#     - jenkins_password.stdout != ""
