---
# Jenkins role - Setup Jenkins with Docker

- name: Install GitLab CLI (glab)
  block:
    - name: Download glab
      get_url:
        url: "https://gitlab.com/gitlab-org/cli/-/releases/v1.36.0/downloads/glab_1.36.0_Linux_x86_64.deb"
        dest: /tmp/glab.deb

    - name: Install glab
      apt:
        deb: /tmp/glab.deb
        state: present

- name: Install Portainer
  docker_container:
    name: portainer
    image: portainer/portainer-ce:latest
    state: started
    restart_policy: always
    ports:
      - "9000:9000"
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - name: app_network

- name: Install OhMyZsh dependencies
  apt:
    name:
      - zsh
      - git
      - curl
    state: present

- name: Install OhMyZsh for root
  shell: |
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  args:
    creates: /root/.oh-my-zsh
  become: yes

- name: Install OhMyZsh for ansible user
  shell: |
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  args:
    creates: "/home/{{ ansible_user }}/.oh-my-zsh"
  become: yes
  become_user: "{{ ansible_user }}"

- name: Change default shell to zsh for ansible user
  user:
    name: "{{ ansible_user }}"
    shell: /bin/zsh

- name: Create Jenkins directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: '0755'
  loop:
    - /var/jenkins_home
    - /var/jenkins_home/certs

- name: Create Jenkins Docker container
  docker_container:
    name: jenkins
    image: jenkins/jenkins:lts
    state: started
    restart_policy: always
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_docker_certs:/certs/client:ro
    env:
      DOCKER_HOST: "tcp://docker:2376"
      DOCKER_CERT_PATH: "/certs/client"
      DOCKER_TLS_VERIFY: "1"
      JAVA_OPTS: "-Djenkins.install.runSetupWizard=false"
    networks:
      - name: app_network
    user: root

- name: Wait for Jenkins to start
  wait_for:
    host: 127.0.0.1
    port: 8080
    delay: 10
    timeout: 300

- name: Install Ansible
  apt:
    name:
      - ansible
      - ansible-lint
    state: present

# ========================
# Nginx + SSL (reordered)
# ========================

- name: Install Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Install Certbot
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present

- name: Configure temporary HTTP-only Nginx site for Jenkins
  template:
    src: jenkins-http.conf.j2 
    dest: /etc/nginx/sites-available/jenkins
    mode: '0644'
  notify: restart nginx

- name: Enable Jenkins site
  file:
    src: /etc/nginx/sites-available/jenkins
    dest: /etc/nginx/sites-enabled/jenkins
    state: link
  notify: restart nginx

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Start and enable Nginx
  systemd:
    name: nginx
    state: started
    enabled: yes

- name: Wait for HTTP to be ready
  wait_for:
    host: 127.0.0.1
    port: 80
    delay: 5
    timeout: 60

- name: Obtain SSL certificate via Certbot
  shell: certbot --nginx -d {{ jenkins_domain }} --non-interactive --agree-tos -m {{ admin_email }}
  register: certbot_result
  changed_when: certbot_result.rc == 0
  notify: reload nginx

- name: Wait for HTTPS to be ready
  wait_for:
    host: 127.0.0.1
    port: 443
    delay: 5
    timeout: 120

# ========================
# Jenkins password retrieval
# ========================

- name: Get Jenkins initial admin password
  shell: docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
  register: jenkins_password
  changed_when: false
  ignore_errors: yes

- name: Display Jenkins initial password
  debug:
    msg: "Jenkins initial admin password: {{ jenkins_password.stdout }}"
  when: jenkins_password.stdout is defined and jenkins_password.stdout != ""
