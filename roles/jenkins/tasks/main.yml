---
# Jenkins role - Setup Jenkins with Docker

- name: Install GitLab CLI (glab)
  block:
    - name: Download glab
      get_url:
        url: "https://gitlab.com/gitlab-org/cli/-/releases/v1.36.0/downloads/glab_1.36.0_Linux_x86_64.deb"
        dest: /tmp/glab.deb

    - name: Install glab
      apt:
        deb: /tmp/glab.deb
        state: present

# ========================
# Jenkins setup
# ========================

- name: Create Jenkins directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  loop:
    - /var/jenkins_home
    - /var/jenkins_home/certs

- name: Create Jenkins Docker container
  docker_container:
    name: jenkins
    image: jenkins/jenkins:lts
    state: started
    restart_policy: always
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_docker_certs:/certs/client:ro
    env:
      DOCKER_HOST: "tcp://docker:2376"
      DOCKER_CERT_PATH: "/certs/client"
      DOCKER_TLS_VERIFY: "1"
      JENKINS_ADMIN_ID: "{{ jenkins_admin_user }}"
      JENKINS_ADMIN_PASSWORD: "{{ jenkins_admin_password }}"
      JAVA_OPTS: "-Djenkins.install.runSetupWizard=false"
    networks:
      - name: app_network
    user: root

- name: Wait for Jenkins to start
  wait_for:
    host: 127.0.0.1
    port: 8080
    delay: 10
    timeout: 300

- name: Install Ansible
  apt:
    name:
      - ansible
      - ansible-lint
    state: present

- name: Get Jenkins initial admin password
  command: docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
  register: jenkins_password
  changed_when: false
  ignore_errors: yes

- name: Display Jenkins admin password
  debug:
    msg: "Jenkins Admin Password: {{ jenkins_password.stdout }}"