---
# SonarQube role - Setup SonarQube

# Required for Elasticsearch inside SonarQube to run properly
- name: Set vm.max_map_count for SonarQube
  sysctl:
    name: vm.max_map_count
    value: '262144'
    state: present
    reload: yes

- name: Create SonarQube directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  loop:
    - /opt/sonarqube/data
    - /opt/sonarqube/extensions
    - /opt/sonarqube/logs

- name: Create Docker network for SonarQube
  docker_network:
    name: app_network
    state: present

# -------------------------------
# PostgreSQL container
# -------------------------------
- name: Create PostgreSQL container for SonarQube
  docker_container:
    name: sonarqube-db
    image: postgres:13
    state: started
    restart_policy: always
    env:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonarqube
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    networks:
      - name: app_network

- name: Wait for PostgreSQL to be ready (using docker exec)
  shell: "docker exec sonarqube-db pg_isready -U sonar"
  register: pg_ready
  retries: 12
  delay: 10
  until: pg_ready.rc == 0
  changed_when: false

# -------------------------------
# SonarQube container
# -------------------------------
- name: Create SonarQube container
  docker_container:
    name: sonarqube
    image: sonarqube:latest
    state: started
    restart_policy: always
    ports:
      - "9001:9000"
    env:
      SONAR_JDBC_URL: "jdbc:postgresql://sonarqube-db:5432/sonarqube"
      SONAR_JDBC_USERNAME: "sonar"
      SONAR_JDBC_PASSWORD: "sonar"
      SONAR_HOST_URL: "http://localhost:9001"
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    networks:
      - name: app_network
    ulimits:
      - nofile:65536:65536

- name: Wait for SonarQube HTTP to be ready
  wait_for:
    host: localhost
    port: 9001
    delay: 10
    timeout: 300
    state: started

- name: Display SonarQube information
  debug:
    msg: |
      âœ… SonarQube is running at http://{{ ansible_host }}:9001
      Default credentials: admin/admin
      Please change the password on first login!